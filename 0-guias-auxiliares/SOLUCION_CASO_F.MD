# Dise√±o para CASO F: Autenticaci√≥n de Dos Factores para Acciones Cr√≠ticas

## Antecedente y Planteamiento del Problema
### Contexto de Seguridad en E-commerce
- **Necesidad identificada:**  
  Operaciones sensibles (cambios de contrase√±a, modificaci√≥n de datos de pago) requieren mayor seguridad
- **Riesgos potenciales:**
  - Acceso no autorizado a cuentas
  - Modificaci√≥n fraudulenta de pedidos
  - Cambios no autorizados en informaci√≥n personal
- **Requerimiento del negocio:**
  - Implementar verificaci√≥n adicional para operaciones cr√≠ticas
  - Mantener experiencia de usuario equilibrada
  - Soluci√≥n integrada con el sistema de WhatsApp existente

### Alcance del Problema
```plaintext
Operaciones cr√≠ticas que requerir√°n 2FA:
1. Cambio de contrase√±a
2. Modificaci√≥n de m√©todos de pago
3. Actualizaci√≥n de direcci√≥n de env√≠o
4. Confirmaci√≥n de pedidos > $5000 MXN
5. Acceso desde dispositivos no reconocidos
```

## Dise√±o de la Soluci√≥n
### 1. Decorador `@reauth_required`
Archivo: `core/decorators.py`
```python
from django.contrib.auth.decorators import user_passes_test
from django.http import JsonResponse
from django.conf import settings

def reauth_required(view_func):
    def wrapper(request, *args, **kwargs):
        if not request.session.get('otp_verified'):
            # Generar y enviar c√≥digo OTP
            code = generate_otp_code()
            send_whatsapp_otp(request.user.whatsapp_number, code)
            
            # Guardar c√≥digo en sesi√≥n con timestamp
            request.session['otp_code'] = code
            request.session['otp_created'] = timezone.now().timestamp()
            
            # Redirigir a verificaci√≥n
            return redirect('verify_reauth')
        return view_func(request, *args, **kwargs)
    return wrapper
```

### 2. Flujo de Verificaci√≥n
```mermaid
sequenceDiagram
    Usuario->>Sistema: Solicita acci√≥n cr√≠tica
    Sistema->>Usuario: Redirige a verificaci√≥n OTP
    Sistema->>WhatsApp: Env√≠a c√≥digo de 6 d√≠gitos
    Usuario->>Sistema: Ingresa c√≥digo recibido
    Sistema->>Sistema: Valida c√≥digo y timestamp
    alt C√≥digo v√°lido
        Sistema->>Usuario: Permite acci√≥n solicitada
        Sistema->>Sistema: Marca sesi√≥n como verificada
    else C√≥digo inv√°lido
        Sistema->>Usuario: Muestra error
    end
```

### 3. Modelo de Dispositivos Confiables
Archivo: `users/models.py`
```python
class TrustedDevice(models.Model):
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.CASCADE,
        related_name='trusted_devices'
    )
    device_hash = models.CharField(max_length=64)  # SHA-256 de user agent + IP
    created_at = models.DateTimeField(auto_now_add=True)
    last_used = models.DateTimeField(auto_now=True)
    
    @classmethod
    def create_hash(cls, request):
        return hashlib.sha256(
            f"{request.META['HTTP_USER_AGENT']}-{request.META['REMOTE_ADDR']}".encode()
        ).hexdigest()
```

### 4. Configuraci√≥n de Seguridad
Archivo: `core/settings.py`
```python
# Configuraci√≥n 2FA
REAUTH_TIMEOUT = 5 * 60  # 5 minutos de validez para OTP
MAX_OTP_ATTEMPTS = 3
OTP_BLOCK_TIME = 15 * 60  # 15 minutos de bloqueo tras intentos fallidos
```

## Componentes Clave del Sistema

### M√≥dulo de Generaci√≥n/Env√≠o OTP
```python
def send_whatsapp_otp(phone_number, code):
    # Implementaci√≥n usando Twilio o servicio similar
    message = f"Tu c√≥digo de verificaci√≥n TUTIENDA es: {code}"
    send_whatsapp_message(phone_number, message)

def generate_otp_code(length=6):
    return ''.join(random.choices('0123456789', k=length))
```

### Vista de Verificaci√≥n
Archivo: `users/views.py`
```python
def verify_reauth(request):
    if request.method == 'POST':
        user_code = request.POST.get('code')
        stored_code = request.session.get('otp_code')
        created_time = request.session.get('otp_created')
        
        # Validar tiempo y c√≥digo
        if timezone.now().timestamp() - created_time > settings.REAUTH_TIMEOUT:
            return render(request, 'users/reauth_expired.html')
            
        if user_code == stored_code:
            request.session['otp_verified'] = True
            return redirect(request.session.get('reauth_redirect', 'home'))
        
        return render(request, 'users/reauth.html', {'error': 'C√≥digo inv√°lido'})
    
    return render(request, 'users/reauth.html')
```

## Beneficios Esperados
### Mejoras de Seguridad
üîí **Protecci√≥n contra acceso no autorizado**  
üõ°Ô∏è **Mitigaci√≥n de riesgos en operaciones sensibles**  
üìâ **Reducci√≥n estimada de 85% en fraudes**  

### Experiencia de Usuario
‚úÖ **Flujo optimizado para dispositivos conocidos**  
‚è±Ô∏è **Verificaci√≥n r√°pida (promedio < 30 segundos)**  
üì± **Integraci√≥n perfecta con WhatsApp existente**  

### Ventajas T√©cnicas
üß© **Arquitectura modular y extensible**  
‚öôÔ∏è **Configuraci√≥n flexible de pol√≠ticas de seguridad**  
üìä **Sistema de auditor√≠a integrado**  

## Pr√≥ximos Pasos para Implementaci√≥n
1. **Desarrollo de componentes principales:**
   - M√≥dulo OTP
   - Gesti√≥n de dispositivos confiables
   - Panel de control de seguridad para usuarios

2. **Integraci√≥n con sistemas existentes:**
   ```mermaid
   graph LR
       A[Decorador @reauth_required] --> B[Vistas cr√≠ticas]
       C[Modelo TrustedDevice] --> D[Sistema de autenticaci√≥n]
       E[Servicio WhatsApp] --> F[M√≥dulo OTP]
   ```

3. **Plan de pruebas:**
   - Pruebas de usabilidad con usuarios reales
   - Simulaciones de ataque
   - Pruebas de carga

4. **Implementaci√≥n gradual:**
   - Fase 1: Cambio de contrase√±a y datos de pago
   - Fase 2: Confirmaci√≥n de pedidos grandes
   - Fase 3: Acceso desde nuevos dispositivos

## Consideraciones de Seguridad Adicionales
- **Cifrado de c√≥digos OTP** en tr√°nsito y almacenamiento
- **Limitaci√≥n de intentos** para prevenir fuerza bruta
- **Registro de auditor√≠a** de todas las operaciones cr√≠ticas
- **Notificaciones inmediatas** al usuario por actividades sospechosas

Este dise√±o proporciona un equilibrio √≥ptimo entre seguridad y experiencia de usuario, preparando el sistema para los m√°s altos est√°ndares de protecci√≥n en operaciones sensibles.